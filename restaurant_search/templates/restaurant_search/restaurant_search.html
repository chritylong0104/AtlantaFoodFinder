{% extends 'base.html' %}

{% block content %}
<h1>Restaurant Search</h1>

<form method="post">
    {% csrf_token %}
    <input type="text" name="search_query" placeholder="Search for restaurants" value="{{ search_query }}">
    <input type="text" name="cuisine_type" placeholder="Cuisine type" value="{{ cuisine_type }}">
    <input type="number" name="min_rating" min="0" max="5" step="0.1" placeholder="Minimum Rating" value="{{ min_rating }}">
    <input type="number" name="max_distance" min="0" step="0.1" placeholder="Maximum Distance (km)" value="{{ max_distance }}">
    <input type="hidden" name="user_lat" id="user_lat">
    <input type="hidden" name="user_lng" id="user_lng">
    <button type="submit">Search</button>
</form>

<div id="map" style="height: 400px; width: 100%;"></div>

{% if restaurants %}
    <h2>Search Results</h2>
    <ul>
    {% for restaurant in restaurants %}
        <li>{{ restaurant.name }} - Rating: {{ restaurant.rating }}, Distance: {{ restaurant.distance }} km</li>
    {% endfor %}
    </ul>
{% endif %}
{% endblock %}

{% block scripts %}
<script src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&callback=initMap" async defer></script>
<script>
function initMap() {
    var map = new google.maps.Map(document.getElementById('map'), {
        center: {lat: 33.7490, lng: -84.3880},
        zoom: 12
    });

    {% if restaurants %}
        var bounds = new google.maps.LatLngBounds();
        {% for restaurant in restaurants %}
            var latLng = new google.maps.LatLng(
                {{ restaurant.geolocation.lat }},
                {{ restaurant.geolocation.lng }}
            );
            var marker = new google.maps.Marker({
                position: latLng,
                map: map,
                title: '{{ restaurant.name }}'
            });
            bounds.extend(latLng);
        {% endfor %}
        map.fitBounds(bounds);
    {% endif %}
}

// Get user's location
if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(position) {
        document.getElementById('user_lat').value = position.coords.latitude;
        document.getElementById('user_lng').value = position.coords.longitude;
    });
}
</script>
{% endblock %}