{% extends 'base.html' %}

{% block content %}
<h1>Restaurant Search</h1>

<form method="POST">
    {% csrf_token %}
    <input type="text" name="search_query" value="{{ search_query }}" placeholder="Search restaurants...">
    <input type="text" name="cuisine_type" value="{{ cuisine_type }}" placeholder="Cuisine type">
    <input type="number" name="min_rating" value="{{ min_rating }}" min="0" max="5" step="0.1" placeholder="Minimum rating">
    <input type="number" name="max_distance" value="{{ max_distance }}" min="0" step="0.1" placeholder="Maximum distance (km)">
    <input type="hidden" name="user_lat" id="user_lat" value="{{ user_lat }}">
    <input type="hidden" name="user_lng" id="user_lng" value="{{ user_lng }}">
    <button type="submit">Search</button>
</form>

<div id="map" style="height: 400px; width: 100%;"></div>

{% if restaurants %}
    <h2>Search Results</h2>
    <div class="restaurant-list">
    {% for restaurant in restaurants %}
        <div class="restaurant-card">
            <h3><a href="{% url 'restaurant_detail' restaurant.place_id %}">{{ restaurant.name }}</a></h3>
            <div class="restaurant-photos">
                {% for photo_url in restaurant.photos %}
                    <img src="{{ photo_url }}" alt="{{ restaurant.name }}" class="restaurant-photo">
                {% endfor %}
            </div>
            <p>Address: {{ restaurant.address }}</p>
            <p>Rating: {{ restaurant.rating }}</p>
            <p>Distance: {{ restaurant.distance }} km</p>
        </div>
    {% endfor %}
    </div>
{% endif %}

<script>
function initMap() {
    const map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: {{ user_lat|default:33.7490 }}, lng: {{ user_lng|default:-84.3880 }} },
        zoom: 12,
    });

    const infoWindow = new google.maps.InfoWindow();

    // Add a marker for the user's location
    new google.maps.Marker({
        position: { lat: {{ user_lat|default:33.7490 }}, lng: {{ user_lng|default:-84.3880 }} },
        map: map,
        title: "Your Location",
        icon: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
    });

    {% if restaurants %}
        const bounds = new google.maps.LatLngBounds();
        {% for restaurant in restaurants %}
        (function() {
            const latLng = new google.maps.LatLng(
                {{ restaurant.geolocation.lat }},
                {{ restaurant.geolocation.lng }}
            );
            const marker = new google.maps.Marker({
                position: latLng,
                map: map,
                title: "{{ restaurant.name }}"
            });
            bounds.extend(latLng);

            marker.addListener("click", function() {
                const content = `
                    <h3>{{ restaurant.name }}</h3>
                    <p>Address: {{ restaurant.address }}</p>
                    <p>Cuisine: {{ restaurant.cuisine_type }}</p>
                    <p>Rating: {{ restaurant.rating }}</p>
                    <p>Distance: {{ restaurant.distance }} km</p>
                `;
                infoWindow.setContent(content);
                infoWindow.open(map, marker);
            });
        })();
        {% endfor %}
        map.fitBounds(bounds);
    {% endif %}
}

// Get user's location
if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(position) {
        document.getElementById('user_lat').value = position.coords.latitude;
        document.getElementById('user_lng').value = position.coords.longitude;
    });
}
</script>
<script src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&callback=initMap" async defer></script>

<style>
.restaurant-list {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
}

.restaurant-card {
    border: 1px solid #ddd;
    padding: 15px;
    border-radius: 8px;
    width: calc(33.333% - 20px);
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.restaurant-photos {
    display: flex;
    overflow-x: auto;
    gap: 10px;
    margin-bottom: 10px;
}

.restaurant-photo {
    width: 150px;
    height: 150px;
    object-fit: cover;
    border-radius: 4px;
}

@media (max-width: 768px) {
    .restaurant-card {
        width: calc(50% - 20px);
    }
}

@media (max-width: 480px) {
    .restaurant-card {
        width: 100%;
    }
}
</style>
{% endblock %}