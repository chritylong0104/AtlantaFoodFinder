{% extends 'base.html' %}
{% load static %}

{% block title %}{{ place.name }} - Details{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/restaurant_details.css' %}">
{% endblock %}

{% block content %}
<main class="restaurant-details">
    <a href="{% url 'map_view' %}" class="back-arrow">
        <i class="fas fa-arrow-left"></i>
    </a>
    <button class="favorite-btn" onclick="toggleFavorite(this)">
        <i class="far fa-heart"></i>
    </button>
    <div class="hero-image">
         {% if place.photos %}
            <img src="https://maps.googleapis.com/maps/api/place/photo?maxwidth=400&photoreference={{ place.photos.0.photo_reference }}&key={{ GOOGLE_MAPS_API_KEY }}" alt="{{ place.name }}">
         {% else %}
            <img src="{% static 'images/default_restaurant.jpg' %}" alt="{{ place.name }}">
         {% endif %}
        <div class="hero-text">
            <h1>{{ place.name }}</h1>
            <div class="rating">
                {% for i in "12345"|make_list %}
                    {% if forloop.counter <= place.rating %}
                        <i class="fas fa-star"></i>
                    {% else %}
                        <i class="far fa-star"></i>
                    {% endif %}
                {% endfor %}
            </div>
            {% if place.opening_hours %}
            <div class="hours">
                <h3>Opening Hours</h3>
                <ul>
                {% for day_hours in place.opening_hours.weekday_text %}
                     <li>{{ day_hours }}</li>
                {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>
    </div>

    <section class="restaurant-info">
        <h2>Restaurant Information</h2>
        <p><strong>Address:</strong> {{ place.formatted_address }}</p>
        <p><strong>Phone:</strong> {{ place.formatted_phone_number|default:"N/A" }}</p>
        <p><strong>Rating:</strong> {{ place.rating|default:"N/A" }}</p>
    </section>

    <section class="reviews">
        <h2>Reviews</h2>
        {% for review in place.reviews %}
            <div class="review-card">
                <h3>{{ review.author_name }}</h3>
                <div class="rating">
                    {% for i in "12345"|make_list %}
                        {% if forloop.counter <= review.rating %}
                            <i class="fas fa-star"></i>
                        {% else %}
                            <i class="far fa-star"></i>
                        {% endif %}
                    {% endfor %}
                </div>
                <p>{{ review.text }}</p>
                <p class="review-date">{{ review.relative_time_description }}</p>
            </div>
        {% empty %}
            <p>No reviews available.</p>
        {% endfor %}
        <button class="btn btn-primary add-review">Post Review</button>
    </section>

    <section class="location">
        <h2>Location</h2>
        <div class="map-container" id="map">
            <!-- Google Maps will be inserted here -->
        </div>
    </section>
</main>
{% endblock %}

{% block extra_js %}
<script src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&callback=initMap" async defer></script>
<script>
    function initMap() {
        var restaurant = {lat: {{ place.geometry.location.lat }}, lng: {{ place.geometry.location.lng }}};
        var map = new google.maps.Map(document.getElementById('map'), {
            zoom: 15,
            center: restaurant
        });
        var marker = new google.maps.Marker({
            position: restaurant,
            map: map
        });
    }

    function toggleFavorite(btn) {
        const icon = btn.querySelector('i');
        if (icon.classList.contains('far')) {
            icon.classList.remove('far');
            icon.classList.add('fas');
        } else {
            icon.classList.remove('fas');
            icon.classList.add('far');
        }
        // Here you would typically send an AJAX request to update the favorite status in the backend
    }
    $(document).ready(function() {
    $('#favorite-btn').click(function() {
        var placeId = $(this).data('place-id');
        var name = $(this).data('name');
        $.ajax({
            url: "{% url 'toggle_favorite' %}",
            method: 'POST',
            data: {
                'place_id': placeId,
                'name': name,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                var btn = $('#favorite-btn');
                var icon = btn.find('i');
                if (response.status === 'added') {
                    icon.removeClass('far').addClass('fas');
                    btn.addClass('active');
                } else if (response.status === 'removed') {
                    icon.removeClass('fas').addClass('far');
                    btn.removeClass('active');
                }
            },
            error: function(xhr, status, error) {
                console.error("Error toggling favorite:", error);
            }
        });
    });
});
</script>
{% endblock %}